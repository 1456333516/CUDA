#include <thrust/device_vector.h>  // 包含Thrust库的设备向量容器
#include <thrust/scan.h>           // 包含Thrust库的扫描操作函数
#include <stdio.h>                 // 包含标准输入输出库，用于打印结果

/*
 * ==================== 程序功能说明 ====================
 * 这是一个使用Thrust库实现前缀扫描(Inclusive Scan)的简单示例
 * 
 * 前缀扫描的概念：
 * 给定输入序列 [a, b, c, d, e]
 * 前缀扫描结果为 [a, a+b, a+b+c, a+b+c+d, a+b+c+d+e]
 * 
 * 举例：输入 [1, 2, 3, 4, 5] → 输出 [1, 3, 6, 10, 15]
 * 
 * Thrust库的优势：
 * 1. 简化了CUDA编程，提供了类似STL的接口
 * 2. 自动处理内存管理和并行化
 * 3. 代码简洁易读，性能优秀
 */

int main(void)
{
    /*
     * ==================== 数据初始化 ====================
     */
    int N = 10;  // 定义要处理的数据元素个数为10
    
    /*
     * 创建GPU设备向量：
     * thrust::device_vector<int> x(N, 0)
     * - 第一个参数N：向量大小（元素个数）
     * - 第二个参数0：初始值（所有元素初始化为0）
     * device_vector会自动在GPU显存中分配空间
     */
    thrust::device_vector<int> x(N, 0);  // 输入向量，初始化为10个0
    thrust::device_vector<int> y(N, 0);  // 输出向量，初始化为10个0
    
    /*
     * ==================== 数据准备阶段 ====================
     * 在主机端循环初始化输入向量x
     * 将x设置为 [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
     */
    for(int i = 0; i < x.size(); i++)  // 遍历向量的所有元素
    {
        x[i] = i + 1;  // 第i个元素赋值为i+1（从1开始递增）
                       // 注意：这里访问的是device_vector，Thrust会自动处理
                       // 从GPU显存到主机内存的数据传输
    }
    
    /*
     * ==================== 核心计算：前缀扫描 ====================
     * thrust::inclusive_scan(输入起始迭代器, 输入结束迭代器, 输出起始迭代器)
     * 
     * 参数详解：
     * - x.begin(): 输入向量的起始位置迭代器
     * - x.end():   输入向量的结束位置迭代器  
     * - y.begin(): 输出向量的起始位置迭代器
     * 
     * 执行过程（以输入[1,2,3,4]为例）：
     * Step 1: y[0] = x[0] = 1
     * Step 2: y[1] = y[0] + x[1] = 1 + 2 = 3
     * Step 3: y[2] = y[1] + x[2] = 3 + 3 = 6
     * Step 4: y[3] = y[2] + x[3] = 6 + 4 = 10
     * 
     * 结果：y = [1, 3, 6, 10]
     * 
     * 性能特点：
     * - Thrust自动利用GPU并行计算
     * - 时间复杂度从CPU的O(n)优化为接近O(log n)
     * - 内部使用了高度优化的CUDA实现
     */
    thrust::inclusive_scan(x.begin(), x.end(), y.begin());
    
    /*
     * ==================== 结果输出 ====================
     * 将计算结果从GPU显存复制到主机并打印
     */
    printf("Input vector x:  ");
    for(int i = 0; i < x.size(); i++)
    {
        printf("%d ", (int)x[i]);  // 打印输入向量x的内容
    }
    printf("\n");
    
    printf("Scan result y:   ");
    for(int i = 0; i < y.size(); i++)  // 遍历输出向量y的所有元素
    {
        printf("%d ", (int)y[i]);      // 打印每个元素的值
                                       // (int)强制转换确保正确的格式化输出
    }
    printf("\n");
    
    /*
     * ==================== 程序结束 ====================
     * Thrust会自动清理GPU资源，无需手动释放device_vector
     * 程序正常退出，返回0表示执行成功
     */
    return 0;
}

/*
 * ==================== 预期输出 ====================
 * Input vector x:  1 2 3 4 5 6 7 8 9 10 
 * Scan result y:   1 3 6 10 15 21 28 36 45 55 
 * 
 * 验证计算过程：
 * 1 = 1
 * 3 = 1 + 2
 * 6 = 1 + 2 + 3
 * 10 = 1 + 2 + 3 + 4
 * 15 = 1 + 2 + 3 + 4 + 5
 * ...以此类推
 */

/*
 * ==================== 学习要点 ====================
 * 1. Thrust库简化了CUDA编程，隐藏了内存管理细节
 * 2. device_vector自动处理GPU显存分配和数据传输
 * 3. inclusive_scan实现了高效的并行前缀扫描
 * 4. 迭代器模式使得代码风格与STL保持一致
 * 5. 适用于需要累积计算的各种场景（积分、统计等）
 */